<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase_chatapp</title>
    <style>.remove:hover{background:aquamarine;}</style>
</head>
<body>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div>
        <div>
            åå‰ï¼š<input type="text" id="uname">
        </div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <button id="send">é€ä¿¡</button>
        </div>
        <div id="output" style="overflow: auto;height: 300px;"></div>
    </div>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Firebaseã¨ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, push, set, remove, update, onChildAdded } 
        from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        // Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "",
            authDomain: "kadai04-chat-5b85e.firebaseapp.com",
            databaseURL: "https://kadai04-chat-5b85e-default-rtdb.firebaseio.com",
            projectId: "kadai04-chat-5b85e",
            storageBucket: "kadai04-chat-5b85e.appspot.com",
            messagingSenderId: "514791600210",
            appId: "1:514791600210:web:c552c26a08d2a9f914af8b",
        };

        // Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, "chat");

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
        async function sendMessage() {
            try {
                const uname = $("#uname").val(); // åå‰
                const text = $("#text").val();   // ã‚³ãƒ¡ãƒ³ãƒˆ
                if (!uname || !text) {
                    alert("åå‰ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }
                
                const now = new Date();
                const formattedDate = now.toLocaleString(); // æ—¥ä»˜ã¨æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                const msg = {
                    uname: uname,
                    text: text,
                    date: formattedDate
                };

                // Firebaseã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                const newPostRef = push(dbRef); 
                await set(newPostRef, msg); // Firebaseã«ä¿å­˜
                console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:", msg); // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›

                // é€ä¿¡å¾Œã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                $("#uname").val("");
                $("#text").val("");
                scrollToBottom(); // é€ä¿¡å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            } catch (error) {
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—
        function onMessageAdded() {
            onChildAdded(dbRef, function (data) {
                const msg = data.val();
                const key = data.key;
                let h = `<p id="${key}"><strong>${msg.uname}</strong><br><small>${msg.date}</small><br>
                    <span contentEditable="true" id="${key}_update">${msg.text}</span>
                    <br>
                    <span class="remove" data-key="${key}">ğŸš®</span>
                    <span class="update" data-key="${key}">ğŸ†™</span>
                    </p>`;
                $("#output").append(h);
                scrollToBottom();
            });
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
        function scrollToBottom() {
            const output = $("#output");
            output.scrollTop(output.prop("scrollHeight"));
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å‡¦ç†
        async function removeMessage(key) {
            try {
                const removeItemRef = ref(db, "chat/" + key);
                await remove(removeItemRef);
            } catch (error) {
                console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°å‡¦ç†
        async function updateMessage(key) {
            try {
                const newText = $(`#${key}_update`).html();
                if (newText === undefined) {
                    throw new Error('æ›´æ–°å¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                const updateRef = ref(db, "chat/" + key);
                await update(updateRef, {
                    text: newText
                });
            } catch (error) {
                console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
                alert("æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#send").on("click", sendMessage);

        // Enterã‚­ãƒ¼ã§ã®é€ä¿¡å‡¦ç†
        $("#text").on("keydown", function (e) {
            if (e.keyCode === 13) sendMessage();
        });

        // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ (å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚‚å¯¾å¿œ)
        $("#output").on("click", ".remove", function () {
            const key = $(this).attr("data-key");
            removeMessage(key);
        });

        // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ (å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚‚å¯¾å¿œ)
        $("#output").on("click", ".update", function () {
            const key = $(this).attr("data-key");
            updateMessage(key);
        });

        // Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
        onMessageAdded();
    </script>

</body>
</html>
